(function(t){t.widget("ui.nestedSortable",t.extend({},t.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"ui-nestedSortable-no-nesting",errorClass:"ui-nestedSortable-error",listType:"ol",maxLevels:0,noJumpFix:0},_create:function(){return this.noJumpFix==!1&&this.element.height(this.element.height()),this.element.data("sortable",this.element.data("nestedSortable")),t.ui.sortable.prototype._create.apply(this,arguments)},_mouseDrag:function(e){if(this.position=this._generatePosition(e),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll){var s=this.options,i=!1;this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-e.pageY<s.scrollSensitivity?this.scrollParent[0].scrollTop=i=this.scrollParent[0].scrollTop+s.scrollSpeed:e.pageY-this.overflowOffset.top<s.scrollSensitivity&&(this.scrollParent[0].scrollTop=i=this.scrollParent[0].scrollTop-s.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-e.pageX<s.scrollSensitivity?this.scrollParent[0].scrollLeft=i=this.scrollParent[0].scrollLeft+s.scrollSpeed:e.pageX-this.overflowOffset.left<s.scrollSensitivity&&(this.scrollParent[0].scrollLeft=i=this.scrollParent[0].scrollLeft-s.scrollSpeed)):(e.pageY-t(document).scrollTop()<s.scrollSensitivity?i=t(document).scrollTop(t(document).scrollTop()-s.scrollSpeed):t(window).height()-(e.pageY-t(document).scrollTop())<s.scrollSensitivity&&(i=t(document).scrollTop(t(document).scrollTop()+s.scrollSpeed)),e.pageX-t(document).scrollLeft()<s.scrollSensitivity?i=t(document).scrollLeft(t(document).scrollLeft()-s.scrollSpeed):t(window).width()-(e.pageX-t(document).scrollLeft())<s.scrollSensitivity&&(i=t(document).scrollLeft(t(document).scrollLeft()+s.scrollSpeed))),i!==!1&&t.ui.ddmanager&&!s.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e)}this.positionAbs=this._convertPositionTo("absolute"),(!this.options.axis||this.options.axis!="y")&&(this.helper[0].style.left=this.position.left+"px"),(!this.options.axis||this.options.axis!="x")&&(this.helper[0].style.top=this.position.top+"px");for(var r=this.items.length-1;r>=0;r--){var l=this.items[r],h=l.item[0],o=this._intersectsWithPointer(l);if(o&&h!=this.currentItem[0]&&this.placeholder[o==1?"next":"prev"]()[0]!=h&&!t.contains(this.placeholder[0],h)&&(this.options.type!="semi-dynamic"||!t.contains(this.element[0],h))){if(this.direction=o==1?"down":"up",this.options.tolerance=="pointer"||this._intersectsWithSides(l))this._rearrange(e,l);else break;this._clearEmpty(h),this._trigger("change",e,this._uiHash());break}}var n=this.placeholder[0].parentNode.parentNode&&t(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?t(this.placeholder[0].parentNode.parentNode):null,p=this._getLevel(this.placeholder),c=this._getChildLevels(this.helper),a=this.placeholder[0].previousSibling?t(this.placeholder[0].previousSibling):null;if(a!=null)for(;a[0].nodeName.toLowerCase()!="li"||a[0]==this.currentItem[0];)if(a[0].previousSibling)a=t(a[0].previousSibling);else{a=null;break}return newList=document.createElement(s.listType),this.beyondMaxLevels=0,n!=null&&this.positionAbs.left<n.offset().left?(n.after(this.placeholder[0]),this._clearEmpty(n[0]),this._trigger("change",e,this._uiHash())):a!=null&&this.positionAbs.left>a.offset().left+s.tabSize?(this._isAllowed(a,p+c+1),a.children(s.listType).length||a[0].appendChild(newList),a.children(s.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",e,this._uiHash())):this._isAllowed(n,p+c),this._contactContainers(e),t.ui.ddmanager&&t.ui.ddmanager.drag(this,e),this._trigger("sort",e,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(e,s){if(this.beyondMaxLevels){for(var i=this.placeholder.parent().closest(this.options.items),r=this.beyondMaxLevels-1;r>0;r--)i=i.parent().closest(this.options.items);this.placeholder.removeClass(this.options.errorClass),i.after(this.placeholder),this._trigger("change",e,this._uiHash())}t.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(e){var s=this._getItemsAsjQuery(e&&e.connected),i=[];return e=e||{},t(s).each(function(){var r=(t(e.item||this).attr(e.attribute||"id")||"").match(e.expression||/(.+)[-=_](.+)/),l=(t(e.item||this).parent(e.listType).parent("li").attr(e.attribute||"id")||"").match(e.expression||/(.+)[-=_](.+)/);r&&i.push((e.key||r[1]+"["+(e.key&&e.expression?r[1]:r[2])+"]")+"="+(l?e.key&&e.expression?l[1]:l[2]:"root"))}),!i.length&&e.key&&i.push(e.key+"="),i.join("&")},toHierarchy:function(e){e=e||{};var s=e.startDepthCount||0,i=[];return t(this.element).children("li").each(function(){var l=r(t(this));i.push(l)}),i;function r(l){var h=(t(l).attr(e.attribute||"id")||"").match(e.expression||/(.+)[-=_](.+)/);if(h!=null){var o={id:h[2]};return t(l).children(e.listType).children("li").length>0&&(o.children=[],t(l).children(e.listType).children("li").each(function(){var n=r(t(this));o.children.push(n)})),o}}},toArray:function(e){e=e||{};var s=e.startDepthCount||0,i=[],r=2;i.push({item_id:"root",parent_id:"none",depth:s,left:"1",right:(t("li",this.element).length+1)*2}),t(this.element).children("li").each(function(){r=h(this,s+1,r)});function l(o,n){return o.left-n.left}return i=i.sort(l),i;function h(o,n,p){return right=p+1,t(o).children(e.listType).children("li").length>0&&(n++,t(o).children(e.listType).children("li").each(function(){right=h(t(this),n,right)}),n--),id=t(o).attr(e.attribute||"id").match(e.expression||/(.+)[-=_](.+)/),n===s+1?pid="root":(parentItem=t(o).parent(e.listType).parent("li").attr("id").match(e.expression||/(.+)[-=_](.+)/),pid=parentItem[2]),id!=null&&i.push({item_id:id[2],parent_id:pid,depth:n,left:p,right}),p=right+1}},_clear:function(e,s){t.ui.sortable.prototype._clear.apply(this,arguments);for(var i=this.items.length-1;i>=0;i--){var r=this.items[i].item[0];this._clearEmpty(r)}return!0},_clearEmpty:function(e){e.children[1]&&e.children[1].children.length==0&&e.removeChild(e.children[1])},_getLevel:function(e){var s=1;if(this.options.listType)for(var i=e.closest(this.options.listType);!i.is(".ui-sortable");)s++,i=i.parent().closest(this.options.listType);return s},_getChildLevels:function(e,s){var i=this,r=this.options,l=0;return s=s||0,t(e).children(r.listType).children(r.items).each(function(h,o){l=Math.max(i._getChildLevels(o,s+1),l)}),s?l+1:l},_isAllowed:function(e,s){var i=this.options;e==null||!e.hasClass(i.disableNesting)?i.maxLevels<s&&i.maxLevels!=0?(this.placeholder.addClass(i.errorClass),this.beyondMaxLevels=s-i.maxLevels):(this.placeholder.removeClass(i.errorClass),this.beyondMaxLevels=0):(this.placeholder.addClass(i.errorClass),i.maxLevels<s&&i.maxLevels!=0?this.beyondMaxLevels=s-i.maxLevels:this.beyondMaxLevels=1)}})),t.ui.nestedSortable.prototype.options=t.extend({},t.ui.sortable.prototype.options,t.ui.nestedSortable.prototype.options)})(jQuery);
